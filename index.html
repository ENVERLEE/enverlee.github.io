f<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>연구 플랫폼</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.6.2/axios.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Noto Sans KR', sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f5f5f5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background-color: #fff;
            padding: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }

        .nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            color: #2c3e50;
        }

        .auth-section {
            display: none;
            padding: 2rem;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }

        .main-content {
            display: none;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 2rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold;
        }

        input, textarea {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 1rem;
        }

        button {
            background-color: #3498db;
            color: white;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #2980b9;
        }

        .project-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .project-card {
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 1rem;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .project-card:hover {
            transform: translateY(-2px);
        }

        .reference-list {
            margin-top: 1rem;
        }

        .reference-item {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .auth-tabs {
            display: flex;
            margin-bottom: 1rem;
            border-bottom: 1px solid #ddd;
        }

        .auth-tab {
            padding: 0.5rem 1rem;
            cursor: pointer;
            border: none;
            background: none;
            color: #666;
            margin-right: 1rem;
        }

        .auth-tab.active {
            color: #3498db;
            border-bottom: 2px solid #3498db;
        }

        .auth-form {
            display: none;
        }

        .auth-form.active {
            display: block;
        }

        .main-tabs {
            display: flex;
            margin-bottom: 1rem;
            border-bottom: 1px solid #ddd;
        }

        .main-tab {
            padding: 0.5rem 1rem;
            cursor: pointer;
            border: none;
            background: none;
            color: #666;
            margin-right: 1rem;
        }

        .main-tab.active {
            color: #3498db;
            border-bottom: 2px solid #3498db;
        }

        .main-content-section {
            display: none;
        }

        .main-content-section.active {
            display: block;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal-content {
            background-color: #fff;
            margin: 15% auto;
            padding: 2rem;
            border-radius: 8px;
            width: 80%;
            max-width: 600px;
            position: relative;
        }

        .modal-close {
            position: absolute;
            right: 1rem;
            top: 1rem;
            cursor: pointer;
            font-size: 1.5rem;
        }

        .loading {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(255,255,255,0.9);
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            z-index: 1100;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .project-list {
                grid-template-columns: 1fr;
            }

            .modal-content {
                width: 95%;
                margin: 10% auto;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="nav container">
            <div class="logo">연구 플랫폼</div>
            <div class="user-info">
                <span id="userEmail"></span>
                <button id="logoutBtn" style="display: none;">로그아웃</button>
            </div>
        </div>
    </div>

    <div class="container">
        <div id="authSection" class="auth-section">
            <div class="auth-tabs">
                <button class="auth-tab active" data-form="login">로그인</button>
                <button class="auth-tab" data-form="register">회원가입</button>
            </div>

            <div id="loginForm" class="auth-form active">
                <h2>로그인</h2>
                <div class="form-group">
                    <label>이메일</label>
                    <input type="email" id="loginEmail" required>
                </div>
                <div class="form-group">
                    <label>비밀번호</label>
                    <input type="password" id="loginPassword" required>
                </div>
                <button id="loginBtn">로그인</button>
            </div>

            <div id="registerForm" class="auth-form">
                <h2>회원가입</h2>
                <div class="form-group">
                    <label>이메일</label>
                    <input type="email" id="registerEmail" required>
                </div>
                <div class="form-group">
                    <label>비밀번호</label>
                    <input type="password" id="registerPassword" required>
                </div>
                <div class="form-group">
                    <label>이름</label>
                    <input type="text" id="registerName" required>
                </div>
                <button id="registerBtn">회원가입</button>
            </div>
        </div>

        <div id="mainContent" class="main-content">
            <div class="main-tabs">
                <button class="main-tab active" data-section="projects">프로젝트</button>
                <button class="main-tab" data-section="references">참고문헌</button>
            </div>

            <div id="projectsSection" class="main-content-section active">
                <button id="newProjectBtn">새 프로젝트 생성</button>
                <div id="projectList" class="project-list"></div>
            </div>

            <div id="referencesSection" class="main-content-section">
                <div class="form-group">
                    <label>키워드 검색</label>
                    <input type="text" id="searchKeywords" placeholder="키워드를 입력하세요">
                    <button id="searchReferencesBtn">검색</button>
                </div>
                <div id="referenceList" class="reference-list"></div>
            </div>
        </div>
    </div>

    <div id="newProjectModal" class="modal">
        <div class="modal-content">
            <span class="modal-close">&times;</span>
            <h2>새 프로젝트</h2>
            <div class="form-group">
                <label>제목</label>
                <input type="text" id="projectTitle" required>
            </div>
            <div class="form-group">
                <label>설명</label>
                <textarea id="projectDescription" required></textarea>
            </div>
            <div class="form-group">
                <label>평가 계획</label>
                <textarea id="evaluationPlan" required></textarea>
            </div>
            <div class="form-group">
                <label>제출 형식</label>
                <textarea id="submissionFormat" required></textarea>
            </div>
            <button id="createProjectBtn">프로젝트 생성</button>
        </div>
    </div>

    <div id="loading" class="loading">처리 중...</div>

    <script>
        const API_BASE_URL = 'https://suhangssalmukapiserver.loca.lt/api';
        let currentUser = null;
        let accessToken = null;

        // Axios 설정
        const api = axios.create({
            baseURL: API_BASE_URL,
            headers: {
                'Content-Type': 'application/json'
            }
        });

        // 토큰 설정
        const setAuthToken = (token) => {
            accessToken = token;
            api.defaults.headers.common['Authorization'] = `Bearer ${token}`;
            localStorage.setItem('token', token);
        };

        // 로딩 표시 함수
        const showLoading = () => {
            document.getElementById('loading').style.display = 'block';
        };

        const hideLoading = () => {
            document.getElementById('loading').style.display = 'none';
        };

        // 초기화
        document.addEventListener('DOMContentLoaded', () => {
            const token = localStorage.getItem('token');
            if (token) {
                setAuthToken(token);
                showMainContent();
                loadProjects();
            } else {
                showAuthSection();
            }

            setupEventListeners();
        });

        // 이벤트 리스너 설정
        function setupEventListeners() {
            // 인증 탭 전환
            document.querySelectorAll('.auth-tab').forEach(tab => {
                tab.addEventListener('click', (e) => {
                    document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
                    
                    e.target.classList.add('active');
                    const formId = `${e.target.dataset.form}Form`;
                    document.getElementById(formId).classList.add('active');
                });
            });

            // 메인 탭 전환
            document.querySelectorAll('.main-tab').forEach(tab => {
                tab.addEventListener('click', (e) => {
                    document.querySelectorAll('.main-tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.main-content-section').forEach(s => s.classList.remove('active'));
                    
                    e.target.classList.add('active');
                    const sectionId = `${e.target.dataset.section}Section`;
                    document.getElementById(sectionId).classList.add('active');
                });
            });

            // 인증 관련
            document.getElementById('loginBtn').addEventListener('click', handleLogin);
            document.getElementById('registerBtn').addEventListener('click', handleRegister);
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);

            // 프로젝트 관련
            document.getElementById('newProjectBtn').addEventListener('click', () => {
                document.getElementById('newProjectModal').style.display = 'block';
            });

            document.getElementById('createProjectBtn').addEventListener('click', handleCreateProject);

            // 모달 닫기
            document.querySelectorAll('.modal-close').forEach(close => {
                close.addEventListener('click', (e) => {
                    e.target.closest('.modal').style.display = 'none';
                });
            });

            // 참고문헌 검색
            document.getElementById('searchReferencesBtn').addEventListener('click', handleReferenceSearch);
        }

        // 화면 전환 함수
        function showAuthSection() {
            document.getElementById('authSection').style.display = 'block';
            document.getElementById('mainContent').style.display = 'none';
            document.getElementById('logoutBtn').style.display = 'none';
        }

        function showMainContent() {
            document.getElementById('authSection').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
            document.getElementById('logoutBtn').style.display = 'block';
        }

        // API 호출 함수들
        async function handleLogin() {
            try {
                showLoading();
                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;

                const response = await api.post('/auth/token', {
                    username: email,
                    password: password
                });

                setAuthToken(response.data.access_token);
                currentUser = email;
                document.getElementById('userEmail').textContent = email;
                showMainContent();
                loadProjects();
            } catch (error) {
                alert('로그인 실패: ' + (error.response?.data?.message || '알 수 없는 오류가 발생했습니다.'));
            } finally {
                hideLoading();
            }
        }

        async function handleRegister() {
            try {
                showLoading();
                const email = document.getElementById('registerEmail').value;
                const password = document.getElementById('registerPassword').value;
                const fullName = document.getElementById('registerName').value;

                const response = await api.post('/auth/register', {
                    email,
                    password,
                    full_name: fullName
                });

                setAuthToken(response.data.access_token);
                currentUser = email;
                document.getElementById('userEmail').textContent = email;
                showMainContent();
                loadProjects();
            } catch (error) {
                alert('회원가입 실패: ' + (error.response?.data?.message || '알 수 없는 오류가 발생했습니다.'));
            } finally {
                hideLoading();
            }
        }

        function handleLogout() {
            localStorage.removeItem('token');
            accessToken = null;
            currentUser = null;
            api.defaults.headers.common['Authorization'] = '';
            document.getElementById('userEmail').textContent = '';
            showAuthSection();
        }

        async function handleCreateProject() {
            try {
                showLoading();
                const title = document.getElementById('projectTitle').value;
                const description = document.getElementById('projectDescription').value;
                const evaluationPlan = document.getElementById('evaluationPlan').value;
                const submissionFormat = document.getElementById('submissionFormat').value;

                const response = await api.post('/projects/', {
                    title,
                    description,
                    evaluation_plan: evaluationPlan,
                    submission_format: submissionFormat
                });

                document.getElementById('newProjectModal').style.display = 'none';
                // 폼 초기화
                document.getElementById('projectTitle').value = '';
                document.getElementById('projectDescription').value = '';
                document.getElementById('evaluationPlan').value = '';
                document.getElementById('submissionFormat').value = '';
                
                await loadProjects();
            } catch (error) {
                alert('프로젝트 생성 실패: ' + (error.response?.data?.message || '알 수 없는 오류가 발생했습니다.'));
            } finally {
                hideLoading();
            }
        }

        async function loadProjects() {
            try {
                showLoading();
                const response = await api.get('/projects/');
                const projectList = document.getElementById('projectList');
                projectList.innerHTML = '';

                response.data.forEach(project => {
                    const projectCard = document.createElement('div');
                    projectCard.className = 'project-card';
                    projectCard.dataset.projectId = project.id;
                    projectCard.innerHTML = `
                        <h3>${project.title}</h3>
                        <p>${project.description}</p>
                        <p>생성일: ${new Date(project.created_at).toLocaleDateString()}</p>
                        <p>상태: ${project.status}</p>
                        <button onclick="executeProjectStep(${project.id}, 1)">다음 단계 실행</button>
                    `;
                    projectList.appendChild(projectCard);
                });
            } catch (error) {
                alert('프로젝트 로드 실패: ' + (error.response?.data?.message || '알 수 없는 오류가 발생했습니다.'));
            } finally {
                hideLoading();
            }
        }

        async function executeProjectStep(projectId, stepNumber) {
            try {
                showLoading();
                const response = await api.post(`/projects/${projectId}/steps/${stepNumber}/execute`);
                
                // 실행 결과를 해당 프로젝트 카드에 표시
                const projectCard = document.querySelector(`[data-project-id="${projectId}"]`);
                const resultDiv = document.createElement('div');
                resultDiv.className = 'execution-result';
                resultDiv.innerHTML = `
                    <h4>실행 결과</h4>
                    <pre>${JSON.stringify(response.data, null, 2)}</pre>
                `;
                
                // 이전 실행 결과가 있다면 제거
                const prevResult = projectCard.querySelector('.execution-result');
                if (prevResult) {
                    prevResult.remove();
                }
                
                projectCard.appendChild(resultDiv);
            } catch (error) {
                alert('단계 실행 실패: ' + (error.response?.data?.message || '알 수 없는 오류가 발생했습니다.'));
            } finally {
                hideLoading();
            }
        }

        async function handleReferenceSearch() {
            try {
                showLoading();
                const keywords = document.getElementById('searchKeywords').value.split(',').map(k => k.trim());
                const projectId = document.querySelector('.main-tab.active').dataset.projectId;

                const response = await api.post(`/references/search?project_id=${projectId}`, {
                    keywords: keywords
                });

                const referenceList = document.getElementById('referenceList');
                referenceList.innerHTML = '';

                response.data.forEach(reference => {
                    const referenceItem = document.createElement('div');
                    referenceItem.className = 'reference-item';
                    referenceItem.innerHTML = `
                        <h3>${reference.title}</h3>
                        <p>저자: ${reference.authors.join(', ')}</p>
                        <p>발행일: ${new Date(reference.publication_date).toLocaleDateString()}</p>
                        <p>${reference.content}</p>
                        <button onclick="loadReferenceSummary(${reference.id})">요약 보기</button>
                    `;
                    referenceList.appendChild(referenceItem);
                });
            } catch (error) {
                alert('참고문헌 검색 실패: ' + (error.response?.data?.message || '알 수 없는 오류가 발생했습니다.'));
            } finally {
                hideLoading();
            }
        }

        async function loadReferenceSummary(referenceId) {
            try {
                showLoading();
                const response = await api.get(`/references/${referenceId}/summary`);
                
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.style.display = 'block';
                modal.innerHTML = `
                    <div class="modal-content">
                        <span class="modal-close">&times;</span>
                        <h2>참고문헌 요약</h2>
                        <div class="summary-content">
                            ${response.data}
                        </div>
                    </div>
                `;

                document.body.appendChild(modal);

                modal.querySelector('.modal-close').onclick = () => {
                    modal.remove();
                };

                window.onclick = (event) => {
                    if (event.target === modal) {
                        modal.remove();
                    }
                };
            } catch (error) {
                alert('요약 로드 실패: ' + (error.response?.data?.message || '알 수 없는 오류가 발생했습니다.'));
            } finally {
                hideLoading();
            }
        }

        // Rate Limiting 처리
        let requestCount = 0;
        const resetTime = 60000; // 1분
        
        setInterval(() => {
            requestCount = 0;
        }, resetTime);

        api.interceptors.request.use(async (config) => {
            if (requestCount >= (accessToken ? 100 : 10)) {
                throw new Error('요청 한도를 초과했습니다. 잠시 후 다시 시도해주세요.');
            }
            requestCount++;
            return config;
        });

        // 에러 처리
        api.interceptors.response.use(
            response => response,
            error => {
                if (error.response?.status === 401) {
                    handleLogout();
                }
                throw error;
            }
        );
    </script>
</body>
</html>
